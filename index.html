<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Fitness Tracker Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #38bdf8; --gray: #94a3b8; --green: #10b981; --red: #ef4444; --gold: #fbbf24; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, sans-serif; 
            margin: 0; 
            padding: 20px; 
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –æ—Ç–¥–∞–ª–µ–Ω–∏—è —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ */
        #main-dashboard, #registration-screen { 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), filter 0.4s ease;
        }
        
        body.modal-open #main-dashboard {
            transform: scale(0.96);
            filter: blur(2px);
        }

        #registration-screen, #main-dashboard { display: none; }

        .card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            margin-bottom: 15px;
            transition: transform 0.2s ease, filter 0.2s ease;
        }

        .sub-card { 
            background: rgba(255,255,255,0.05); 
            padding: 12px; 
            border-radius: 15px; 
            text-align: center;
            transition: transform 0.2s ease;
        }

        .card-active {
            transform: scale(0.92) !important;
            filter: brightness(0.8);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
        }

        /* --- –ú–û–î–ê–õ–ö–ò (iOS Style) --- */
        .modal { 
            display: flex; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0); 
            z-index: 100; 
            align-items: center; 
            justify-content: center; 
            pointer-events: none;
            transition: background 0.3s ease;
        }

        .modal-content { 
            background: var(--card); 
            width: 90%; 
            padding: 25px; 
            border-radius: 30px; 
            box-sizing: border-box;
            opacity: 0;
            transform: translateY(40px) scale(0.95);
            transition: transform 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.1), opacity 0.3s ease;
        }

        .modal.active { 
            pointer-events: auto; 
            background: rgba(0,0,0,0.7); 
        }

        .modal.active .modal-content { 
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        input, select, textarea { 
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #334155;
            background: #0f172a; color: white; font-size: 16px; box-sizing: border-box;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.2s;
        }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        label { font-size: 11px; color: var(--gray); margin-left: 5px; text-transform: uppercase; }
        .btn { 
            background: var(--accent); color: var(--bg); border: none; padding: 15px; 
            border-radius: 15px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer;
        }
        .battle-badge { background: var(--gold); color: black; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; margin-bottom: 5px; display: inline-block; }
        .vs-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin-top: 10px; }
        .vs-val { font-size: 14px; font-weight: bold; color: var(--accent); }
    </style>
</head>
<body>

<div id="registration-screen">
    <div class="card">
        <h2 style="margin-top:0">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è üìä</h2>
        <input type="text" id="reg-name" placeholder="–¢–≤–æ–µ –∏–º—è">
        <label>–ü–æ–ª</label>
        <select id="reg-gender">
            <option value="–ú—É–∂—Å–∫–æ–π">–ú—É–∂—Å–∫–æ–π</option>
            <option value="–ñ–µ–Ω—Å–∫–∏–π">–ñ–µ–Ω—Å–∫–∏–π</option>
        </select>
        <div class="grid-3" style="grid-template-columns: 1fr 1fr;">
            <div><label>–í–æ–∑—Ä–∞—Å—Ç</label><input type="number" id="reg-age" placeholder="–ª–µ—Ç"></div>
            <div><label>–†–æ—Å—Ç</label><input type="number" id="reg-height" placeholder="—Å–º"></div>
        </div>
        <div class="grid-3" style="grid-template-columns: 1fr 1fr;">
            <div><label>–¢–µ–∫—É—â–∏–π –≤–µ—Å</label><input type="number" id="reg-weight" step="0.1" placeholder="–∫–≥"></div>
            <div><label>–¶–µ–ª—å –≤–µ—Å–∞</label><input type="number" id="reg-target" step="0.1" placeholder="–∫–≥"></div>
        </div>
        <label>–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ</label>
        <select id="reg-body">
            <option value="–•—É–¥–æ—â–∞–≤–æ–µ">–•—É–¥–æ—â–∞–≤–æ–µ</option>
            <option value="–°—Ä–µ–¥–Ω–µ–µ">–°—Ä–µ–¥–Ω–µ–µ</option>
            <option value="–ü–ª–æ—Ç–Ω–æ–µ">–ü–ª–æ—Ç–Ω–æ–µ</option>
        </select>
        <label>–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å</label>
        <select id="reg-goal">
            <option value="–ü–æ—Ö—É–¥–µ–Ω–∏–µ">–ü–æ—Ö—É–¥–µ–Ω–∏–µ</option>
            <option value="–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ">–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ</option>
            <option value="–ú–∞—Å—Å–∞">–ù–∞–±–æ—Ä –º–∞—Å—Å—ã</option>
        </select>
        <label>–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</label>
        <select id="reg-activity">
            <option value="–°–∏–¥—è—á–∏–π">–°–∏–¥—è—á–∏–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏</option>
            <option value="–õ–µ–≥–∫–∏–π">–õ–µ–≥–∫–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (1-3 –≤ –Ω–µ–¥.)</option>
            <option value="–¢—è–∂–µ–ª—ã–π">–¢—è–∂–µ–ª—ã–π —Å–ø–æ—Ä—Ç (5+ –≤ –Ω–µ–¥.)</option>
        </select>
        <button class="btn" onclick="register()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</button>
    </div>
</div>

<div id="main-dashboard">
    <div class="card">
        <div id="battle-indicator" style="display:none;" class="battle-badge">–†–ï–ñ–ò–ú –ë–ê–¢–¢–õ–ê (–ü–†–û–°–ú–û–¢–†)</div>
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h2 id="user-greeting" style="margin: 0;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p id="user-profile-info" style="color: var(--gray); margin: 5px 0 0 0; font-size: 14px;"></p>
            </div>
            <div style="text-align: right;">
                <div id="display-today-kcal" style="font-size: 22px; font-weight: bold; color: var(--accent);">0</div>
                <div style="font-size: 11px; color: var(--gray);">–∫–∫–∞–ª —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
            <div class="sub-card" onclick="animatePress(this); openModal('modal-steps')" style="cursor: pointer;">
                <span style="font-size: 11px; color: var(--gray);">–®–ê–ì–ò <span style="color: var(--accent);">+</span></span><br>
                <span id="last-steps" style="font-weight: bold; font-size: 18px; color: var(--accent);">-</span>
            </div>
            <div class="sub-card" onclick="animatePress(this);">
                <span style="font-size: 11px; color: var(--gray);">–í–ï–°</span><br>
                <span id="last-weight" style="font-weight: bold; font-size: 18px; color: var(--accent);">-</span>
            </div>
        </div>
    </div>

    <div id="action-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="card" onclick="animatePress(this); openModal('modal-food')" style="text-align: center; margin-bottom: 0;">
            <span style="font-size: 24px;">üçé</span><br><b>–ï–¥–∞</b>
        </div>
        <div class="card" onclick="animatePress(this); openModal('modal-water')" style="text-align: center; margin-bottom: 0;">
            <span style="font-size: 24px;">üíß</span><br><b id="display-today-water">0.00 –ª</b>
        </div>
        <div class="card" style="grid-column: span 2; margin-top: 0;" onclick="animatePress(this); openModal('modal-activity')">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span>üèÉ‚Äç‚ôÇÔ∏è</span> <b>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –∏—Ç–æ–≥–∏</b> <span style="margin-left:auto; color:var(--accent);">‚ûî</span>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 20px; border: 1px solid rgba(251, 191, 36, 0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 16px; color: var(--gold);">‚öîÔ∏è –ë–∞—Ç—Ç–ª</h3>
            <select id="rival-select" onchange="compareWith()" style="width: auto; margin: 0; padding: 5px; font-size: 12px; height: 35px;">
                <option value="">–°–æ–ø–µ—Ä–Ω–∏–∫...</option>
            </select>
        </div>
        <div class="vs-grid">
            <div style="text-align: center;">–Ø<br><span id="my-weekly-steps" class="vs-val">0</span></div>
            <div style="color: var(--gray); font-size: 10px; text-transform: uppercase;">—à–∞–≥–∏ (7–¥)</div>
            <div style="text-align: center;"><span id="rival-name">-</span><br><span id="rival-weekly-steps" class="vs-val">0</span></div>
        </div>
        <button id="back-to-me" class="btn" style="display:none; font-size: 12px; padding: 10px; background: #334155; color: white;" onclick="loadData()">–ù–∞–∑–∞–¥ –∫ —Å–µ–±–µ</button>
    </div>
</div>

<div id="modal-water" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3>–í–æ–¥–∞ üíß</h3>
        <input type="number" id="in-only-water" step="0.05" value="0.25" style="text-align: center; font-size: 28px; font-weight: bold; color: var(--accent); background: none; border: none; width: 100%;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin: 15px 0;">
            <div onclick="adjustWater(-0.1)" style="width: 45px; height: 45px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--red); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--red); font-weight: bold; cursor: pointer;">-0.1</div>
            <div style="display: flex; gap: 10px;">
                <div onclick="setWaterValue(0.25)" style="padding: 8px 15px; background: var(--card); border: 1px solid var(--gray); border-radius: 10px; font-size: 12px; cursor: pointer;">0.25</div>
                <div onclick="setWaterValue(0.5)" style="padding: 8px 15px; background: var(--card); border: 1px solid var(--gray); border-radius: 10px; font-size: 12px; cursor: pointer;">0.5</div>
            </div>
            <div onclick="adjustWater(0.1)" style="width: 45px; height: 45px; background: rgba(16, 185, 129, 0.1); border: 1px solid var(--green); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--green); font-weight: bold; cursor: pointer;">+0.1</div>
        </div>
        <button class="btn" onclick="sendWater()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" style="background:none; color:var(--gray); margin-top: 5px;" onclick="closeModals()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div id="modal-food" class="modal">
    <div class="modal-content">
        <h3>–ü—Ä–∏–µ–º –ø–∏—â–∏ üçΩÔ∏è</h3>
        <select id="food-type"><option>–ó–∞–≤—Ç—Ä–∞–∫</option><option>–û–±–µ–¥</option><option>–£–∂–∏–Ω</option><option>–ü–µ—Ä–µ–∫—É—Å</option></select>
        <input type="text" id="food-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <input type="number" id="food-kcal" placeholder="–ö–∫–∞–ª">
        <div class="grid-3">
            <div><label>–ë</label><input type="number" id="food-p" placeholder="–≥"></div>
            <div><label>–ñ</label><input type="number" id="food-f" placeholder="–≥"></div>
            <div><label>–£</label><input type="number" id="food-c" placeholder="–≥"></div>
        </div>
        <button class="btn" onclick="sendFood()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" style="background:none; color:white;" onclick="closeModals()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div id="modal-activity" class="modal">
    <div class="modal-content">
        <h3>–ò—Ç–æ–≥–∏ –¥–Ω—è üèÉ‚Äç‚ôÇÔ∏è</h3>
        <input type="number" id="in-steps" placeholder="–®–∞–≥–∏">
        <input type="number" id="in-weight" step="0.1" placeholder="–í–µ—Å —É—Ç—Ä–æ–º">
        <input type="text" id="in-workout" placeholder="–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞">
        <textarea id="in-notes" placeholder="–ó–∞–º–µ—Ç–∫–∏" rows="2"></textarea>
        <button class="btn" onclick="sendActivity()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn" style="background:none; color:white;" onclick="closeModals()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div id="modal-steps" class="modal">
    <div class="modal-content">
        <h3>–í–≤–µ—Å—Ç–∏ —à–∞–≥–∏ üèÉ‚Äç‚ôÇÔ∏è</h3>
        <input type="number" id="quick-steps" placeholder="–°–∫–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è?">
        <button class="btn" onclick="sendQuickSteps()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" style="background:none; color:white;" onclick="closeModals()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const API_URL = 'https://script.google.com/macros/s/AKfycbz1Tw6c4pNJpkd_FEOBvmsvU3QlYWXf4V-O_L2fCWc9xdBLleVFikJHmKr3TYs6Kmp6/exec';
    const user = tg.initDataUnsafe?.user || { id: 12345, first_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" };
    
    tg.expand();
    tg.setHeaderColor('#0f172a');
    tg.setBackgroundColor('#0f172a');
    loadData();
    loadUsers();

    function openModal(id) {
        document.getElementById(id).classList.add('active');
        document.body.classList.add('modal-open');
    }

    function closeModals() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        document.body.classList.remove('modal-open');
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) closeModals();
    }

    function animatePress(el) {
        el.classList.add('card-active');
        setTimeout(() => el.classList.remove('card-active'), 150);
    }

    // --- –§–£–ù–ö–¶–ò–ò –í–û–î–´ –° –í–ò–ó–£–ê–õ–¨–ù–´–ú –≠–§–§–ï–ö–¢–û–ú ---
    function adjustWater(step) {
        const input = document.getElementById('in-only-water');
        let current = parseFloat(input.value) || 0;
        let newValue = (current + step).toFixed(2);
        if (newValue < 0) newValue = 0;
        
        input.value = newValue;
        
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
        input.style.transform = "scale(1.15)";
        input.style.color = step > 0 ? "var(--green)" : "var(--red)";
        setTimeout(() => {
            input.style.transform = "scale(1)";
            input.style.color = "var(--accent)";
        }, 200);
    }

    function setWaterValue(val) {
        const input = document.getElementById('in-only-water');
        input.value = val;
        
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç "–ø—Ä—ã–∂–∫–∞"
        input.style.transform = "scale(1.2)";
        setTimeout(() => {
            input.style.transform = "scale(1)";
        }, 200);
    }

    function loadData(compareId = null) {
        fetch(`${API_URL}?userId=${user.id}${compareId ? '&compareId='+compareId : ''}`)
            .then(r => r.json())
            .then(res => {
                if (res.needRegistration) {
                    document.getElementById('registration-screen').style.display = 'block';
                } else {
                    showDashboard(res, !!compareId);
                }
            }).catch(e => alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö"));
    }

    function loadUsers() {
        fetch(`${API_URL}?userId=${user.id}&action=getUsers`).then(r => r.json()).then(res => {
            const select = document.getElementById('rival-select');
            select.innerHTML = '<option value="">–°–æ–ø–µ—Ä–Ω–∏–∫...</option>';
            res.users.forEach(u => {
                let opt = document.createElement('option');
                opt.value = u.id; opt.innerText = u.name;
                select.appendChild(opt);
            });
        });
    }

    function showDashboard(res, isBattle) {
        document.getElementById('registration-screen').style.display = 'none';
        document.getElementById('main-dashboard').style.display = 'block';
        
        if (!isBattle) {
            document.getElementById('my-weekly-steps').innerText = res.weeklyStats?.steps || 0;
            document.getElementById('battle-indicator').style.display = 'none';
            document.getElementById('back-to-me').style.display = 'none';
            document.getElementById('action-buttons').style.opacity = '1';
            document.getElementById('action-buttons').style.pointerEvents = 'auto';
        } else {
            document.getElementById('battle-indicator').style.display = 'inline-block';
            document.getElementById('back-to-me').style.display = 'block';
            document.getElementById('rival-name').innerText = res.profile.name;
            document.getElementById('rival-weekly-steps').innerText = res.weeklyStats?.steps || 0;
            document.getElementById('action-buttons').style.opacity = '0.3';
            document.getElementById('action-buttons').style.pointerEvents = 'none';
        }

        let bmi = parseFloat(res.profile.bmi);
        let bmiText = "–ù–µ —É–∫–∞–∑–∞–Ω";
        let bmiColor = "var(--gray)";
        if (bmi) {
            if (bmi < 18.5) { bmiText = "–î–µ—Ñ–∏—Ü–∏—Ç"; bmiColor = "#38bdf8"; }
            else if (bmi < 25) { bmiText = "–ù–æ—Ä–º–∞"; bmiColor = "#10b981"; }
            else if (bmi < 30) { bmiText = "–ò–∑–±—ã—Ç–æ–∫"; bmiColor = "#fbbf24"; }
            else { bmiText = "–û–∂–∏—Ä–µ–Ω–∏–µ"; bmiColor = "#ef4444"; }
        }

        document.getElementById('user-greeting').innerText = isBattle ? res.profile.name : `–ü—Ä–∏–≤–µ—Ç, ${res.profile.name}!`;
        document.getElementById('user-profile-info').innerHTML = `${res.profile.age} –ª–µ—Ç, ${res.profile.bodyType} <span style="color: var(--gray); margin: 0 3px;">‚Ä¢</span> –ò–ú–¢: ${bmi || "-"} <span style="color: ${bmiColor}; font-weight: bold;">(${bmiText})</span>`;
        document.getElementById('display-today-kcal').innerText = Math.round(res.todayKcal || 0);

        const norm = (!isNaN(parseFloat(res.profile.waterNorm))) ? parseFloat(res.profile.waterNorm).toFixed(1) : "2.5";
        const todayWater = parseFloat(res.todayWater || 0).toFixed(2);
        document.getElementById('display-today-water').innerText = `${todayWater} / ${norm} –ª`;
        document.getElementById('last-steps').innerText = res.lastStats.steps || "-";

        const weightEl = document.getElementById('last-weight');
        if (res.lastStats.weight && res.lastStats.weight !== "-") {
            weightEl.innerHTML = `${res.lastStats.weight} –∫–≥${res.lastStats.weightDate ? `<br><span style="font-size:10px;font-weight:normal;">–∑–∞ ${res.lastStats.weightDate}</span>` : ''}`;
        } else { weightEl.innerText = "-"; }
    }

    function compareWith() {
        const rid = document.getElementById('rival-select').value;
        if (rid) loadData(rid);
    }

    function register() {
        const name = document.getElementById('reg-name').value;
        const height = parseFloat(document.getElementById('reg-height').value);
        const weight = parseFloat(document.getElementById('reg-weight').value);
        const age = document.getElementById('reg-age').value;
        if (!name || !height || !weight || !age) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");
        const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
        submit({
            userId: user.id, type: 'register', userName: name, height, age,
            bodyType: document.getElementById('reg-body').value,
            currentWeight: weight, targetWeight: document.getElementById('reg-target').value,
            gender: document.getElementById('reg-gender').value,
            activity: document.getElementById('reg-activity').value,
            goal: document.getElementById('reg-goal').value, bmi
        });
    }

    function sendFood() {
        const kcal = document.getElementById('food-kcal').value;
        if(!kcal) return alert("–í–≤–µ–¥–∏ –ö–∫–∞–ª!");
        closeModals();
        submit({
            userId: user.id, type: 'food_entry',
            mealType: document.getElementById('food-type').value,
            foodName: document.getElementById('food-name').value || "–ï–¥–∞",
            kcal: kcal, p: document.getElementById('food-p').value || "-",
            f: document.getElementById('food-f').value || "-", c: document.getElementById('food-c').value || "-"
        });
    }

    function sendWater() {
        const amount = document.getElementById('in-only-water').value;
        if(!amount) return;
        closeModals();
        submit({ userId: user.id, type: 'activity', water: amount, steps: "-", weight: "-", workout: "-", notes: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–¥—ã" });
    }

    function sendActivity() {
        closeModals();
        submit({
            userId: user.id, type: 'activity',
            steps: document.getElementById('in-steps').value || "-",
            weight: document.getElementById('in-weight').value || "-",
            workout: document.getElementById('in-workout').value || "-",
            notes: document.getElementById('in-notes').value || "-"
        });
    }

    function submit(payload, isQuiet = false) {
        if (!isQuiet) { 
		
		tg.MainButton.setParams({
            text: "–°–û–•–†–ê–ù–ï–ù–ò–ï...",
            color: "#38bdf8", // –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –∫–Ω–æ–ø–∫–∏ (—Ç–≤–æ–π --accent)
            text_color: "#0f172a" // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–Ω–æ–ø–∫–µ (—Ç–≤–æ–π --bg)
        });
		
		tg.MainButton.show();
		tg.MainButton.setText("–°–û–•–†–ê–ù–ï–ù–ò–ï...");
		}
        fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
        .then(() => {
            if (!isQuiet) {
                tg.MainButton.setText("–ì–û–¢–û–í–û!");
                setTimeout(() => { tg.MainButton.hide(); loadData(); }, 500);
            } else loadData();
        }).catch(err => { tg.MainButton.hide(); alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); });
    }

    function sendQuickSteps() {
        const s = document.getElementById('quick-steps').value;
        if(!s) return alert("–í–≤–µ–¥–∏—Ç–µ —à–∞–≥–∏!");
        document.getElementById('last-steps').innerText = s; 
        closeModals();
        submit({ userId: user.id, type: 'activity', steps: s, weight: "-", workout: "-", notes: "–ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ" });
    }
</script>
</body>
</html>
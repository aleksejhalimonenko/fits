<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fitness Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #38bdf8; --gray: #94a3b8; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; overflow-x: hidden; }
        
        /* –°–æ—Å—Ç–æ—è–Ω–∏—è —ç–∫—Ä–∞–Ω–æ–≤ */
        #registration-screen, #main-dashboard { display: none; }

        /* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .card { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        h2 { margin: 0 0 10px; font-size: 14px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; }
        .value { font-size: 28px; font-weight: 800; color: var(--text); }
        .unit { font-size: 14px; color: var(--gray); margin-left: 4px; }

        /* –ö–æ–ª—å—Ü–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
        .circle-container { position: relative; width: 100px; height: 100px; margin: 10px auto; }
        svg { transform: rotate(-90deg); width: 100px; height: 100px; }
        circle { fill: none; stroke-width: 8; stroke: #334155; }
        .progress { stroke: var(--accent); stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s ease-in-out; stroke-linecap: round; }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ */
        input, select { 
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 1px solid #334155;
            background: #1e293b; color: white; font-size: 16px; box-sizing: border-box;
        }
        .btn-main { 
            background: var(--accent); color: #0f172a; border: none; width: 100%; padding: 16px; 
            border-radius: 15px; font-weight: bold; font-size: 16px; margin-top: 20px; cursor: pointer;
        }
        
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 100; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div id="registration-screen">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="font-size: 24px;">–ü—Ä–∏–≤–µ—Ç! üëã</h1>
            <p style="color: var(--gray);">–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ –æ–¥–∏–Ω —Ä–∞–∑, —á—Ç–æ–±—ã –º—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</p>
        </div>
        <div class="card">
            <input type="number" id="reg-height" placeholder="–†–æ—Å—Ç (—Å–º)" inputmode="numeric">
            <input type="number" id="reg-age" placeholder="–í–æ–∑—Ä–∞—Å—Ç" inputmode="numeric">
            <select id="reg-body">
                <option value="" disabled selected>–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ</option>
                <option value="–•—É–¥–æ—â–∞–≤–æ–µ">–•—É–¥–æ—â–∞–≤–æ–µ</option>
                <option value="–°—Ä–µ–¥–Ω–µ–µ">–°—Ä–µ–¥–Ω–µ–µ</option>
                <option value="–ü–ª–æ—Ç–Ω–æ–µ">–ü–ª–æ—Ç–Ω–æ–µ</option>
            </select>
            <button class="btn-main" onclick="saveProfile()">–°–û–ó–î–ê–¢–¨ –ü–†–û–§–ò–õ–¨</button>
        </div>
    </div>

    <div id="main-dashboard">
        <div id="user-info" style="margin-bottom: 20px; font-size: 18px; font-weight: bold;"></div>
        
        <div class="dashboard">
            <div class="card full-width">
                <h2>–®–∞–≥–∏ —Å–µ–≥–æ–¥–Ω—è</h2>
                <div class="value" id="steps-val">0</div>
                <div class="unit">–∏–∑ 10 000</div>
            </div>
            
            <div class="card">
                <h2>–í–æ–¥–∞</h2>
                <div class="circle-container">
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45"/>
                        <circle class="progress" id="water-circle" cx="50" cy="50" r="45"/>
                    </svg>
                </div>
                <div id="water-val" style="font-weight: bold;">0/2000</div>
                <div class="unit">–º–ª</div>
            </div>

            <div class="card">
                <h2>–í–µ—Å</h2>
                <div style="margin-top: 25px;">
                    <span class="value" id="weight-val">--</span>
                    <span class="unit">–∫–≥</span>
                </div>
            </div>
        </div>

        <button class="btn-main" onclick="showEntryForm()">+ –ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –°–°–´–õ–ö–ê –ù–ê –¢–í–û–ô GAS
        const API_URL = 'https://script.google.com/macros/s/AKfycbzxfLZz3KulUigMh-yqCDc14zVla9rjPaqFCwR0GgWw44djHPSU0ic5T3_F1VOYgLGK/exec';
        
        const user = tg.initDataUnsafe.user || { id: 12345, first_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' };
        let userProfile = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        fetch(`${API_URL}?userId=${user.id}&userName=${user.first_name}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                if (data.needRegistration) {
                    document.getElementById('registration-screen').style.display = 'block';
                } else {
                    document.getElementById('main-dashboard').style.display = 'block';
                    document.getElementById('user-info').innerText = `–ü—Ä–∏–≤–µ—Ç, ${user.first_name}! ‚ú®`;
                    userProfile = data.profile;
                    
                    if (data.lastStats) {
                        document.getElementById('steps-val').innerText = data.lastStats.steps || 0;
                        document.getElementById('weight-val').innerText = data.lastStats.weight || '--';
                        updateWaterCircle(data.lastStats.water || 0, data.lastStats.waterGoal || 2000);
                    }
                }
            })
            .catch(err => alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err));

        function updateWaterCircle(fact, goal) {
            const percent = Math.min((fact / goal) * 100, 100);
            const offset = 283 - (283 * percent) / 100;
            document.getElementById('water-circle').style.strokeDashoffset = offset;
            document.getElementById('water-val').innerText = `${fact}/${goal}`;
        }

        function saveProfile() {
            const height = document.getElementById('reg-height').value;
            const age = document.getElementById('reg-age').value;
            const body = document.getElementById('reg-body').value;

            if (!height || !age || !body) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");

            const params = new URLSearchParams();
            params.append('type', 'register');
            params.append('userId', user.id);
            params.append('height', height);
            params.append('age', age);
            params.append('bodyType', body);

            sendData(params);
        }

        function showEntryForm() {
            const weight = prompt("–¢–≤–æ–π –≤–µ—Å —Å–µ–≥–æ–¥–Ω—è (–∫–≥)?", "70");
            const steps = prompt("–°–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ –ø—Ä–æ—à–µ–ª?", "5000");
            const water = prompt("–°–∫–æ–ª—å–∫–æ –≤–æ–¥—ã –≤—ã–ø–∏–ª (–º–ª)?", "1500");

            if (weight && steps && water) {
                const params = new URLSearchParams();
                params.append('userId', user.id);
                params.append('weight', weight);
                params.append('steps', steps);
                params.append('water', water);
                params.append('waterGoal', 2000);
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
                params.append('height', userProfile.height);
                params.append('age', userProfile.age);
                params.append('bodyType', userProfile.bodyType);

                sendData(params);
            }
        }

function sendData(params) {
    tg.MainButton.show();
    tg.MainButton.setText("–°–û–•–†–ê–ù–ï–ù–ò–ï...");
    
    // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –æ–±—ä–µ–∫—Ç, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ JSON-—Å—Ç—Ä–æ–∫—É
    const obj = Object.fromEntries(params.entries());

    fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors', // –û—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è GAS
        headers: {
            'Content-Type': 'text/plain' // –í–∞–∂–Ω–æ: –¥–ª—è no-cors –ª—É—á—à–µ —Å–ª–∞—Ç—å –∫–∞–∫ plain text
        },
        body: JSON.stringify(obj)
    })
    .then(() => {
        // –î–∞–µ–º Google Script 1 —Å–µ–∫—É–Ω–¥—É –Ω–∞ –∑–∞–ø–∏—Å—å –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
        setTimeout(() => {
            tg.MainButton.hide();
            location.reload();
        }, 1000);
    })
    .catch(err => {
        alert("–û—à–∏–±–∫–∞: " + err);
        tg.MainButton.hide();
    });
}
    </script>
</body>
</html>
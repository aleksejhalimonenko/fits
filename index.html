<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Fitness Tracker Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #38bdf8; --gray: #94a3b8; --green: #10b981; --red: #ef4444; --gold: #fbbf24; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; padding-bottom: 100px; }
        
        #registration-screen, #main-dashboard { display: none; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        input, select, textarea { 
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #334155;
            background: #0f172a; color: white; font-size: 16px; box-sizing: border-box;
        }
        
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        label { font-size: 11px; color: var(--gray); margin-left: 5px; text-transform: uppercase; }

        .btn { 
            background: var(--accent); color: var(--bg); border: none; padding: 15px; 
            border-radius: 15px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer;
        }

        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; 
        }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); width: 90%; padding: 25px; border-radius: 25px; box-sizing: border-box; }

        .sub-card { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 15px; text-align: center; }
        
        /* –ë–∞—Ç—Ç–ª —Å—Ç–∏–ª–∏ */
        .battle-badge { background: var(--gold); color: black; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; margin-bottom: 5px; display: inline-block; }
        .vs-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin-top: 10px; }
        .vs-val { font-size: 14px; font-weight: bold; color: var(--accent); }
    </style>
</head>
<body>

<div id="registration-screen">
    <div class="card">
        <h2 style="margin-top:0">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è üìä</h2>
        
        <input type="text" id="reg-name" placeholder="–¢–≤–æ–µ –∏–º—è">
        
        <label>–ü–æ–ª</label>
        <select id="reg-gender">
            <option value="–ú—É–∂—Å–∫–æ–π">–ú—É–∂—Å–∫–æ–π</option>
            <option value="–ñ–µ–Ω—Å–∫–∏–π">–ñ–µ–Ω—Å–∫–∏–π</option>
        </select>

        <div class="grid-3" style="grid-template-columns: 1fr 1fr;">
            <div><label>–í–æ–∑—Ä–∞—Å—Ç</label><input type="number" id="reg-age" placeholder="–ª–µ—Ç"></div>
            <div><label>–†–æ—Å—Ç</label><input type="number" id="reg-height" placeholder="—Å–º"></div>
        </div>

        <div class="grid-3" style="grid-template-columns: 1fr 1fr;">
            <div><label>–¢–µ–∫—É—â–∏–π –≤–µ—Å</label><input type="number" id="reg-weight" step="0.1" placeholder="–∫–≥"></div>
            <div><label>–¶–µ–ª—å –≤–µ—Å–∞</label><input type="number" id="reg-target" step="0.1" placeholder="–∫–≥"></div>
        </div>

        <label>–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ</label>
        <select id="reg-body">
            <option value="–•—É–¥–æ—â–∞–≤–æ–µ">–•—É–¥–æ—â–∞–≤–æ–µ</option>
            <option value="–°—Ä–µ–¥–Ω–µ–µ">–°—Ä–µ–¥–Ω–µ–µ</option>
            <option value="–ü–ª–æ—Ç–Ω–æ–µ">–ü–ª–æ—Ç–Ω–æ–µ</option>
        </select>

        <label>–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å</label>
        <select id="reg-goal">
            <option value="–ü–æ—Ö—É–¥–µ–Ω–∏–µ">–ü–æ—Ö—É–¥–µ–Ω–∏–µ</option>
            <option value="–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ">–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ</option>
            <option value="–ú–∞—Å—Å–∞">–ù–∞–±–æ—Ä –º–∞—Å—Å—ã</option>
        </select>

        <label>–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</label>
        <select id="reg-activity">
            <option value="–°–∏–¥—è—á–∏–π">–°–∏–¥—è—á–∏–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏</option>
            <option value="–õ–µ–≥–∫–∏–π">–õ–µ–≥–∫–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (1-3 –≤ –Ω–µ–¥.)</option>
            <option value="–¢—è–∂–µ–ª—ã–π">–¢—è–∂–µ–ª—ã–π —Å–ø–æ—Ä—Ç (5+ –≤ –Ω–µ–¥.)</option>
        </select>

        <button class="btn" onclick="register()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</button>
    </div>
</div>

    <div id="main-dashboard">
        <div class="card">
            <div id="battle-indicator" style="display:none;" class="battle-badge">–†–ï–ñ–ò–ú –ë–ê–¢–¢–õ–ê (–ü–†–û–°–ú–û–¢–†)</div>
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 id="user-greeting" style="margin: 0;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <p id="user-profile-info" style="color: var(--gray); margin: 5px 0 0 0; font-size: 14px;"></p>
                </div>
                <div style="text-align: right;">
                    <div id="display-today-kcal" style="font-size: 22px; font-weight: bold; color: var(--accent);">0</div>
                    <div style="font-size: 11px; color: var(--gray);">–∫–∫–∞–ª —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <div class="sub-card" onclick="openModal('modal-steps')" style="cursor: pointer;">
    <span style="font-size: 11px; color: var(--gray);">–®–ê–ì–ò <span style="color: var(--accent);">+</span></span><br>
    <span id="last-steps" style="font-weight: bold; font-size: 18px; color: var(--accent);">-</span>
</div>
                <div class="sub-card">
                    <span style="font-size: 11px; color: var(--gray);">–í–ï–°</span><br>
                    <span id="last-weight" style="font-weight: bold; font-size: 18px; color: var(--accent);">-</span>
                </div>
            </div>
        </div>

        <div id="action-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="card" onclick="openModal('modal-food')" style="text-align: center; margin-bottom: 0;">
                <span style="font-size: 24px;">üçé</span><br><b>–ï–¥–∞</b>
            </div>
            <div class="card" onclick="openModal('modal-water')" style="text-align: center; margin-bottom: 0;">
                <span style="font-size: 24px;">üíß</span><br><b id="display-today-water">0.00 –ª</b>
            </div>
            <div class="card" style="grid-column: span 2; margin-top: 0;" onclick="openModal('modal-activity')">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>üèÉ‚Äç‚ôÇÔ∏è</span> <b>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –∏—Ç–æ–≥–∏</b> <span style="margin-left:auto; color:var(--accent);">‚ûî</span>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px; border: 1px solid rgba(251, 191, 36, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 16px; color: var(--gold);">‚öîÔ∏è –ë–∞—Ç—Ç–ª</h3>
                <select id="rival-select" onchange="compareWith()" style="width: auto; margin: 0; padding: 5px; font-size: 12px; height: 35px;">
                    <option value="">–°–æ–ø–µ—Ä–Ω–∏–∫...</option>
                </select>
            </div>
            <div class="vs-grid">
                <div style="text-align: center;">–Ø<br><span id="my-weekly-steps" class="vs-val">0</span></div>
                <div style="color: var(--gray); font-size: 10px; text-transform: uppercase;">—à–∞–≥–∏ (7–¥)</div>
                <div style="text-align: center;"><span id="rival-name">-</span><br><span id="rival-weekly-steps" class="vs-val">0</span></div>
            </div>
            <button id="back-to-me" class="btn" style="display:none; font-size: 12px; padding: 10px; background: #334155; color: white;" onclick="loadData()">–ù–∞–∑–∞–¥ –∫ —Å–µ–±–µ</button>
        </div>
    </div>

    <div id="modal-water" class="modal"><div class="modal-content">
        <h3>–í–æ–¥–∞ üíß</h3><input type="number" id="in-only-water" step="0.1" value="0.25"><button class="btn" onclick="sendWater()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn" style="background:none; color:white;" onclick="closeModals()">–û—Ç–º–µ–Ω–∞</button>
    </div></div>

    <div id="modal-food" class="modal"><div class="modal-content">
        <h3>–ü—Ä–∏–µ–º –ø–∏—â–∏ üçΩÔ∏è</h3>
        <select id="food-type"><option>–ó–∞–≤—Ç—Ä–∞–∫</option><option>–û–±–µ–¥</option><option>–£–∂–∏–Ω</option><option>–ü–µ—Ä–µ–∫—É—Å</option></select>
        <input type="text" id="food-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <input type="number" id="food-kcal" placeholder="–ö–∫–∞–ª">
        <div class="grid-3">
            <div><label>–ë</label><input type="number" id="food-p" placeholder="–≥"></div>
            <div><label>–ñ</label><input type="number" id="food-f" placeholder="–≥"></div>
            <div><label>–£</label><input type="number" id="food-c" placeholder="–≥"></div>
        </div>
        <button class="btn" onclick="sendFood()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" style="background:none; color:white;" onclick="closeModals()">–û—Ç–º–µ–Ω–∞</button>
    </div></div>

<div id="modal-activity" class="modal">
        <div class="modal-content">
            <h3>–ò—Ç–æ–≥–∏ –¥–Ω—è üèÉ‚Äç‚ôÇÔ∏è</h3>
            <input type="number" id="in-steps" placeholder="–®–∞–≥–∏">
            <input type="number" id="in-weight" step="0.1" placeholder="–í–µ—Å —É—Ç—Ä–æ–º">
            <input type="text" id="in-workout" placeholder="–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞">
            <textarea id="in-notes" placeholder="–ó–∞–º–µ—Ç–∫–∏" rows="2"></textarea>
            <button class="btn" onclick="sendActivity()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn" style="background:none; color:white;" onclick="closeModals()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div> <div id="modal-steps" class="modal">
        <div class="modal-content">
            <h3>–í–≤–µ—Å—Ç–∏ —à–∞–≥–∏ üèÉ‚Äç‚ôÇÔ∏è</h3>
            <input type="number" id="quick-steps" placeholder="–°–∫–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è?">
            <button class="btn" onclick="sendQuickSteps()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn" style="background:none; color:white;" onclick="closeModals()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        // –ó–ê–ú–ï–ù–ò–¢–ï –°–°–´–õ–ö–£ –ù–ò–ñ–ï
        const API_URL = 'https://script.google.com/macros/s/AKfycbz1Tw6c4pNJpkd_FEOBvmsvU3QlYWXf4V-O_L2fCWc9xdBLleVFikJHmKr3TYs6Kmp6/exec';
        const user = tg.initDataUnsafe?.user || { id: 12345, first_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" };
        
        tg.expand(); // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
		tg.setHeaderColor('#0f172a'); // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç —à–∞–ø–∫–∏ (—Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π)
        tg.setBackgroundColor('#0f172a'); // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Å–∞–º–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        loadData();
        loadUsers();

/**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞.
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
         * @param {string|null} compareId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –±–∞—Ç—Ç–ª–∞).
         */
        function loadData(compareId = null) {
            fetch(`${API_URL}?userId=${user.id}${compareId ? '&compareId='+compareId : ''}`)
                .then(r => r.json())
                .then(res => {
                    if (res.needRegistration) {
                        document.getElementById('registration-screen').style.display = 'block';
                    } else {
                        showDashboard(res, !!compareId);
                    }
                }).catch(e => alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö"));
        }

/**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞.
         */
        function loadUsers() {
            fetch(`${API_URL}?userId=${user.id}&action=getUsers`).then(r => r.json()).then(res => {
                const select = document.getElementById('rival-select');
                select.innerHTML = '<option value="">–°–æ–ø–µ—Ä–Ω–∏–∫...</option>';
                res.users.forEach(u => {
                    let opt = document.createElement('option');
                    opt.value = u.id; opt.innerText = u.name;
                    select.appendChild(opt);
                });
            });
        }

/**
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω (Dashboard) —Å –¥–∞–Ω–Ω—ã–º–∏.
         * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ò–ú–¢, –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–ª–æ—Ä–∏–π, –≤–æ–¥—ã –∏ —à–∞–≥–æ–≤.
         * @param {Object} res - –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç API.
         * @param {boolean} isBattle - –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, —Å–º–æ—Ç—Ä–∏–º –ª–∏ –º—ã —á—É–∂–æ–π –ø—Ä–æ—Ñ–∏–ª—å.
         */
function showDashboard(res, isBattle) {
            document.getElementById('registration-screen').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            
            if (!isBattle) {
                document.getElementById('my-weekly-steps').innerText = res.weeklyStats?.steps || 0;
                document.getElementById('battle-indicator').style.display = 'none';
                document.getElementById('back-to-me').style.display = 'none';
                document.getElementById('action-buttons').style.opacity = '1';
                document.getElementById('action-buttons').style.pointerEvents = 'auto';
            } else {
                document.getElementById('battle-indicator').style.display = 'inline-block';
                document.getElementById('back-to-me').style.display = 'block';
                document.getElementById('rival-name').innerText = res.profile.name;
                document.getElementById('rival-weekly-steps').innerText = res.weeklyStats?.steps || 0;
                document.getElementById('action-buttons').style.opacity = '0.3';
                document.getElementById('action-buttons').style.pointerEvents = 'none';
            }

            // --- –õ–û–ì–ò–ö–ê –ê–ù–ê–õ–ò–¢–ò–ö–ò –ò–ú–¢ ---
            let bmi = parseFloat(res.profile.bmi);
            let bmiText = "–ù–µ —É–∫–∞–∑–∞–Ω";
            let bmiColor = "var(--gray)";

            if (bmi) {
                if (bmi < 18.5) { bmiText = "–î–µ—Ñ–∏—Ü–∏—Ç"; bmiColor = "#38bdf8"; } // –ì–æ–ª—É–±–æ–π
                else if (bmi < 25) { bmiText = "–ù–æ—Ä–º–∞"; bmiColor = "#10b981"; } // –ó–µ–ª–µ–Ω—ã–π
                else if (bmi < 30) { bmiText = "–ò–∑–±—ã—Ç–æ–∫"; bmiColor = "#fbbf24"; } // –ñ–µ–ª—Ç—ã–π
                else { bmiText = "–û–∂–∏—Ä–µ–Ω–∏–µ"; bmiColor = "#ef4444"; } // –ö—Ä–∞—Å–Ω—ã–π
            }

            document.getElementById('user-greeting').innerText = isBattle ? res.profile.name : `–ü—Ä–∏–≤–µ—Ç, ${res.profile.name}!`;
            
            // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –°–¢–†–û–ö–ê –ü–†–û–§–ò–õ–Ø –° –ò–ú–¢
            document.getElementById('user-profile-info').innerHTML = `
                ${res.profile.age} –ª–µ—Ç, ${res.profile.bodyType} 
                <span style="color: var(--gray); margin: 0 3px;">‚Ä¢</span> 
                –ò–ú–¢: ${bmi || "-"} <span style="color: ${bmiColor}; font-weight: bold;">(${bmiText})</span>
            `;

            document.getElementById('display-today-kcal').innerText = Math.round(res.todayKcal || 0);
            //–ë—ã–ª–æ: document.getElementById('display-today-water').innerText = (res.todayWater || 0) + " –ª";


// –ë–µ—Ä–µ–º –Ω–æ—Ä–º—É, –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ —á–∏—Å–ª–æ –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞
const normRaw = res.profile.waterNorm;
const norm = (!isNaN(parseFloat(normRaw))) ? parseFloat(normRaw).toFixed(1) : "2.5";

// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—ã–ø–∏—Ç–æ–µ (—Ç–æ–∂–µ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã)
const todayWater = parseFloat(res.todayWater || 0).toFixed(2);

document.getElementById('display-today-water').innerText = `${todayWater} / ${norm} –ª`;




            document.getElementById('last-steps').innerText = res.lastStats.steps || "-";

            const weightEl = document.getElementById('last-weight');
            if (res.lastStats.weight && res.lastStats.weight !== "-") {
                weightEl.innerHTML = `${res.lastStats.weight} –∫–≥${res.lastStats.weightDate ? `<br><span style="font-size:10px;font-weight:normal;">–∑–∞ ${res.lastStats.weightDate}</span>` : ''}`;
            } else { weightEl.innerText = "-"; }
        }


        function compareWith() {
            const rid = document.getElementById('rival-select').value;
            if (rid) loadData(rid);
        }

function register() {
    const name = document.getElementById('reg-name').value;
    const height = parseFloat(document.getElementById('reg-height').value);
    const weight = parseFloat(document.getElementById('reg-weight').value);
    const age = document.getElementById('reg-age').value;
    
    if (!name || !height || !weight || !age) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");
        return;
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –ò–ú–¢ (BMI = –≤–µ—Å / —Ä–æ—Å—Ç_–≤_–º–µ—Ç—Ä–∞—Ö^2)
    const heightInMeters = height / 100;
    const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);

    const data = {
        userId: user.id,
        type: 'register',
        userName: name,
        height: height,
        age: age,
        bodyType: document.getElementById('reg-body').value,
        currentWeight: weight,
        targetWeight: document.getElementById('reg-target').value,
        gender: document.getElementById('reg-gender').value,
        activity: document.getElementById('reg-activity').value,
        goal: document.getElementById('reg-goal').value,
        bmi: bmi
    };

    submit(data);
}

function sendFood() {
    const kcal = document.getElementById('food-kcal').value;
    if(!kcal) return alert("–í–≤–µ–¥–∏ –ö–∫–∞–ª!");
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –°–†–ê–ó–£ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
    closeModals(); 
    
    submit({
        userId: user.id, type: 'food_entry',
        mealType: document.getElementById('food-type').value,
        foodName: document.getElementById('food-name').value || "–ï–¥–∞",
        kcal: kcal,
        p: document.getElementById('food-p').value || "-",
        f: document.getElementById('food-f').value || "-",
        c: document.getElementById('food-c').value || "-"
    });
}

function sendWater() {
    const amount = document.getElementById('in-only-water').value;
    if(!amount) return;

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –°–†–ê–ó–£
    closeModals();

    submit({
        userId: user.id, type: 'activity', 
        water: amount,
        steps: "-", weight: "-", workout: "-", notes: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–¥—ã"
    });
}

function sendActivity() {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –°–†–ê–ó–£
    closeModals();

    submit({
        userId: user.id, type: 'activity',
        steps: document.getElementById('in-steps').value || "-",
        weight: document.getElementById('in-weight').value || "-",
        workout: document.getElementById('in-workout').value || "-",
        notes: document.getElementById('in-notes').value || "-"
    });
}

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }


/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Google –¢–∞–±–ª–∏—Ü—É.
 * * –ß–¢–û –û–ù–ê –î–ï–õ–ê–ï–¢:
 * 1. –í–∏–∑—É–∞–ª—å–Ω–æ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –Ω–∞—á–∞–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ MainButton Telegram.
 * 2. –ü–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ (payload) –º–µ—Ç–æ–¥–æ–º POST –Ω–∞ —Å–µ—Ä–≤–µ—Ä Google Apps Script.
 * 3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∂–∏–º 'no-cors' –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Google.
 * 4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ë–ï–ó –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã,
 * —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –∏ –ø–ª–∞–≤–Ω–æ–π.
 * * @param {Object} payload - –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–≤–µ–¥–µ–Ω–∏—è –æ –µ–¥–µ –∏–ª–∏ —à–∞–≥–∞—Ö).
 */

function submit(payload, isQuiet = false) {
    if (!isQuiet) {
        tg.MainButton.show();
        tg.MainButton.setText("–°–û–•–†–ê–ù–ï–ù–ò–ï...");
    }

    fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(payload)
    })
    .then(() => {
        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–Ω–µ —Ç–∏—Ö–∞—è)
        if (!isQuiet) {
            tg.MainButton.setText("–ì–û–¢–û–í–û!");
            setTimeout(() => {
                tg.MainButton.hide();
                closeModals(); // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –¥—É–±–ª–∏—Ä—É–µ–º —Ç—É—Ç
                loadData();    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            }, 500);
        } else {
            // –ï—Å–ª–∏ —Ç–∏—Ö–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–∫–∞–∫ –≤ —à–∞–≥–∞—Ö)
            loadData();
        }
    })
    .catch(err => {
        console.error(err);
        tg.MainButton.hide();
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
    });
}
		
function sendQuickSteps() {
    const s = document.getElementById('quick-steps').value;
    if(!s) return alert("–í–≤–µ–¥–∏—Ç–µ —à–∞–≥–∏!");

    // 1. –û–ü–¢–ò–ú–ò–ó–ú: –°—Ä–∞–∑—É –º–µ–Ω—è–µ–º —Ü–∏—Ñ—Ä—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å —Å–µ—Ä–≤–µ—Ä–∞
    const stepsElement = document.getElementById('last-steps');
    const oldSteps = stepsElement.innerText; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏
    stepsElement.innerText = s; 
    // stepsElement.style.color = "var(--green)"; // –ü–æ–¥—Å–≤–µ—Ç–∏–º –∑–µ–ª–µ–Ω—ã–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ "–≤ –ø—É—Ç–∏"

    // 2. –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å—Ä–∞–∑—É
    closeModals();

    // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
    submit({
        userId: user.id, 
        type: 'activity',
        steps: s,
        weight: "-", 
        workout: "-", 
        notes: "–ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
    }, true); // –î–æ–±–∞–≤–∏–º —Ñ–ª–∞–≥ true, —á—Ç–æ–±—ã submit –∑–Ω–∞–ª, —á—Ç–æ —ç—Ç–æ —Ç–∏—Ö–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
}
    </script>
</body>
</html>
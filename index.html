<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Fitness Tracker Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #38bdf8; --gray: #94a3b8; --green: #10b981; --red: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; padding-bottom: 100px; }
        
        #registration-screen, #main-dashboard { display: none; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        .btn { background: var(--accent); color: #0f172a; border: none; padding: 15px; border-radius: 15px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        
        .stat-row { display: flex; justify-content: space-between; margin: 15px 0; padding-bottom: 10px; border-bottom: 1px solid #334155; }
        .stat-value { font-size: 24px; font-weight: bold; color: var(--accent); }
        .stat-label { color: var(--gray); font-size: 14px; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .analyt-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 15px; text-align: center; }
        .analyt-label { font-size: 11px; color: var(--gray); display: block; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .analyt-value { font-size: 16px; font-weight: bold; color: var(--accent); }
        .meal-mini-item { display: flex; justify-content: space-between; font-size: 13px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .stability-badge { display: block; text-align: center; padding: 8px; border-radius: 12px; font-size: 12px; margin-top: 15px; font-weight: bold; }

        /* –°—Ç–∏–ª–∏ –±–∞—Ç—Ç–ª–∞ */
        .progress-container { background: #334155; height: 12px; border-radius: 6px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.5s ease; }
        .my-bar { background: var(--accent); }
        .target-bar { background: var(--red); }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); width: 90%; max-height: 80vh; overflow-y: auto; padding: 25px; border-radius: 25px; }
    </style>
</head>
<body>

    <div id="registration-screen">
        <div class="card">
            <h2>–ü—Ä–∏–≤–µ—Ç! üëã</h2>
            <p style="color:var(--gray)">–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
            <input type="text" id="reg-name" placeholder="–¢–≤–æ–µ –∏–º—è">
            <input type="number" id="reg-height" placeholder="–†–æ—Å—Ç (—Å–º)">
            <input type="number" id="reg-age" placeholder="–í–æ–∑—Ä–∞—Å—Ç">
            <select id="reg-body">
                <option value="–•—É–¥–æ—â–∞–≤–æ–µ">–•—É–¥–æ—â–∞–≤–æ–µ</option>
                <option value="–°—Ä–µ–¥–Ω–µ–µ">–°—Ä–µ–¥–Ω–µ–µ</option>
                <option value="–ü–ª–æ—Ç–Ω–æ–µ">–ü–ª–æ—Ç–Ω–æ–µ</option>
            </select>
            <button class="btn" onclick="register()">–ü–û–ï–•–ê–õ–ò</button>
        </div>
    </div>

    <div id="main-dashboard">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="user-name">...</h2>
                <span id="user-age" style="color:var(--gray)"></span>
            </div>
            
            <div class="stat-row">
                <div><span class="stat-label">–ö–∞–ª–æ—Ä–∏–∏ —Å–µ–≥–æ–¥–Ω—è</span><br><span class="stat-value" id="today-kcal">0</span></div>
                <div style="text-align: right;"><span class="stat-label">–í–æ–¥–∞ (–ª)</span><br><span class="stat-value" id="today-water">0</span></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px;">
                    <span class="stat-label">–®–∞–≥–∏</span><br><span id="last-steps" style="font-weight: bold;">-</span>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px;">
                    <span class="stat-label">–í–µ—Å</span><br><span id="last-weight" style="font-weight: bold;">-</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0">‚öîÔ∏è –ë–∞—Ç—Ç–ª –ø–æ —à–∞–≥–∞–º</h3>
            <select id="compare-user-select" onchange="loadComparison()">
                <option value="">–í—ã–±–µ—Ä–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</option>
            </select>
            
            <div id="compare-stats" style="display:none; margin-top:15px;">
                <div class="progress-container"><div id="my-steps-bar" class="progress-bar my-bar"></div></div>
                <div class="progress-container"><div id="target-steps-bar" class="progress-bar target-bar"></div></div>
                <p id="compare-details" style="font-size:12px; color:var(--gray); text-align:center;"></p>
            </div>
        </div>

        <div class="card" id="weekly-analytics-card" style="display:none;">
            <h3 style="margin-top:0">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π</h3>
            <div id="recent-meals-list"></div>
            
            <div class="analytics-grid">
                <div class="analyt-item">
                    <span class="analyt-label">–°—Ä–µ–¥–Ω–µ–µ –∫–∫–∞–ª</span>
                    <span class="analyt-value" id="avg-kcal">-</span>
                </div>
                <div class="analyt-item">
                    <span class="analyt-label">–ë–µ–ª–∫–∏ (—Å—Ä)</span>
                    <span class="analyt-value" id="avg-p">-</span>
                </div>
                <div class="analyt-item">
                    <span class="analyt-label">–ñ–∏—Ä—ã (—Å—Ä)</span>
                    <span class="analyt-value" id="avg-f">-</span>
                </div>
                <div class="analyt-item">
                    <span class="analyt-label">–£–≥–ª–µ–≤. (—Å—Ä)</span>
                    <span class="analyt-value" id="avg-c">-</span>
                </div>
            </div>
            <div id="stability-status" class="stability-badge"></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn" onclick="openModal('food-modal')">üçé –ï–¥–∞</button>
            <button class="btn" onclick="openModal('activity-modal')">üí™ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</button>
        </div>
        <button class="btn btn-outline" style="margin-top:10px" onclick="openModal('water-modal')">üíß –ë—ã—Å—Ç—Ä–∞—è –≤–æ–¥–∞</button>
    </div>

    <div id="food-modal" class="modal">
        <div class="modal-content">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –µ–¥—É</h3>
            <select id="food-type">
                <option>–ó–∞–≤—Ç—Ä–∞–∫</option><option>–û–±–µ–¥</option><option>–£–∂–∏–Ω</option><option>–ü–µ—Ä–µ–∫—É—Å</option>
            </select>
            <input type="text" id="food-name" placeholder="–ß—Ç–æ —Å—ä–µ–ª–∏?">
            <input type="number" id="food-amount" placeholder="–ö–æ–ª-–≤–æ (–≥/—à—Ç)">
            <input type="number" id="food-kcal" placeholder="–ö–∞–ª–æ—Ä–∏–∏">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                <input type="number" id="food-p" placeholder="–ë">
                <input type="number" id="food-f" placeholder="–ñ">
                <input type="number" id="food-c" placeholder="–£">
            </div>
            <button class="btn" onclick="sendFood()">–°–û–•–†–ê–ù–ò–¢–¨</button>
            <button class="btn btn-outline" onclick="closeModal('food-modal')">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div id="activity-modal" class="modal">
        <div class="modal-content">
            <h3>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
            <input type="number" id="in-steps" placeholder="–®–∞–≥–∏ –∑–∞ –¥–µ–Ω—å">
            <input type="number" id="in-weight" step="0.1" placeholder="–í–µ—Å —É—Ç—Ä–æ–º (–∫–≥)">
            <input type="text" id="in-workout" placeholder="–§–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞">
            <input type="number" id="in-water" step="0.1" placeholder="–î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—ã (–ª)">
            <input type="text" id="in-notes" placeholder="–ó–∞–º–µ—Ç–∫–∏">
            <button class="btn" onclick="sendActivity()">–û–ë–ù–û–í–ò–¢–¨</button>
            <button class="btn btn-outline" onclick="closeModal('activity-modal')">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div id="water-modal" class="modal">
        <div class="modal-content">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—É (–ª)</h3>
            <input type="number" id="in-only-water" step="0.1" value="0.25">
            <button class="btn" onclick="sendWater()">–î–û–ë–ê–í–ò–¢–¨</button>
            <button class="btn btn-outline" onclick="closeModal('water-modal')">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ—é —Å—Å—ã–ª–∫—É –Ω–∞ Web App –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è!
        const API_URL = 'https://script.google.com/macros/s/AKfycbz1Tw6c4pNJpkd_FEOBvmsvU3QlYWXf4V-O_L2fCWc9xdBLleVFikJHmKr3TYs6Kmp6/exec';
        
        let user = { id: tg.initDataUnsafe?.user?.id || 'TEST_USER' };
        let currentStats = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        fetch(`${API_URL}?userId=${user.id}`)
            .then(r => r.json())
            .then(data => {
                if (data.needRegistration) {
                    document.getElementById('registration-screen').style.display = 'block';
                } else {
                    currentStats = data;
                    renderDashboard(data);
                    loadUserList();
                }
            });

        function register() {
            const data = {
                userId: user.id,
                type: 'register',
                userName: document.getElementById('reg-name').value,
                height: document.getElementById('reg-height').value,
                age: document.getElementById('reg-age').value,
                bodyType: document.getElementById('reg-body').value
            };
            submit(data);
        }

        function renderDashboard(data) {
            document.getElementById('registration-screen').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            
            document.getElementById('user-name').innerText = data.profile.name;
            document.getElementById('user-age').innerText = `${data.profile.age} –ª–µ—Ç, ${data.profile.bodyType}`;
            document.getElementById('today-kcal').innerText = data.todayKcal;
            document.getElementById('today-water').innerText = data.todayWater;
            document.getElementById('last-steps').innerText = data.lastStats.steps;
            document.getElementById('last-weight').innerText = data.lastStats.weight + ' –∫–≥';

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
            if (data.weeklyStats) {
                document.getElementById('weekly-analytics-card').style.display = 'block';
                document.getElementById('avg-kcal').innerText = data.weeklyStats.avgKcal;
                document.getElementById('avg-p').innerText = data.weeklyStats.avgP + '–≥';
                document.getElementById('avg-f').innerText = data.weeklyStats.avgF + '–≥';
                document.getElementById('avg-c').innerText = data.weeklyStats.avgC + '–≥';

                const days = data.weeklyStats.daysRecorded;
                const statusEl = document.getElementById('stability-status');
                if (days >= 6) { statusEl.innerText = "üî• –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: –ö—Ä–∞—Å–∞–≤—á–∏–∫!"; statusEl.style.background = "var(--green)"; statusEl.style.color = "white"; }
                else if (days >= 3) { statusEl.innerText = "üìà –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: –•–æ—Ä–æ—à–æ"; statusEl.style.background = "var(--accent)"; statusEl.style.color = "#000"; }
                else { statusEl.innerText = "üìâ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: –ù—É–∂–Ω–æ —á–∞—â–µ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å"; statusEl.style.background = "var(--card)"; statusEl.style.border = "1px solid var(--gray)"; }

                const mealsList = document.getElementById('recent-meals-list');
                mealsList.innerHTML = '<p style="font-size:12px; color:var(--gray); margin-bottom:5px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–∏–µ–º—ã –ø–∏—â–∏:</p>';
                if (data.weeklyStats.recentMeals && data.weeklyStats.recentMeals.length > 0) {
                    data.weeklyStats.recentMeals.forEach(meal => {
                        mealsList.innerHTML += `
                            <div class="meal-mini-item">
                                <span style="color:var(--text)">${meal.name}</span>
                                <span style="color:var(--accent); font-weight:500;">${meal.kcal} –∫–∫–∞–ª</span>
                            </div>
                        `;
                    });
                } else {
                    mealsList.innerHTML += '<p style="font-size:13px; color:var(--gray)">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ –Ω–µ–¥–µ–ª—é</p>';
                }
            }
        }

        function loadUserList() {
            fetch(`${API_URL}?userId=${user.id}&action=getUsers`)
                .then(r => r.json())
                .then(res => {
                    const select = document.getElementById('compare-user-select');
                    res.users.forEach(u => {
                        let opt = document.createElement('option');
                        opt.value = u.id;
                        opt.innerText = u.name;
                        select.appendChild(opt);
                    });
                });
        }

        function loadComparison() {
            const compareId = document.getElementById('compare-user-select').value;
            if (!compareId) return;

            fetch(`${API_URL}?userId=${user.id}&compareId=${compareId}`)
                .then(r => r.json())
                .then(resTarget => {
                    const mySteps = parseInt(currentStats.lastStats.steps) || 0;
                    const targetSteps = parseInt(resTarget.lastStats.steps) || 0;
                    const total = mySteps + targetSteps || 1;

                    document.getElementById('compare-stats').style.display = 'block';
                    document.getElementById('my-steps-bar').style.width = (mySteps / total * 100) + '%';
                    document.getElementById('target-steps-bar').style.width = (targetSteps / total * 100) + '%';
                    document.getElementById('compare-details').innerText = `–Ø: ${mySteps} / ${resTarget.profile.name}: ${targetSteps}`;
                });
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function sendFood() {
            const data = {
                userId: user.id, type: 'food_entry',
                mealType: document.getElementById('food-type').value,
                foodName: document.getElementById('food-name').value,
                amount: document.getElementById('food-amount').value,
                kcal: document.getElementById('food-kcal').value,
                p: document.getElementById('food-p').value,
                f: document.getElementById('food-f').value,
                c: document.getElementById('food-c').value
            };
            if (!data.kcal) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–∞–ª–æ—Ä–∏–∏");
            submit(data);
        }

        function sendActivity() {
            submit({
                userId: user.id, type: 'activity',
                weight: document.getElementById('in-weight').value,
                steps: document.getElementById('in-steps').value,
                water: document.getElementById('in-water').value,
                workout: document.getElementById('in-workout').value,
                notes: document.getElementById('in-notes').value
            });
        }
        
        function sendWater() {
            const val = document.getElementById('in-only-water').value;
            if (!val || val <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–¥—ã");
            submit({
                userId: user.id, type: 'activity', water: val,
                steps: "-", weight: "-", workout: "-", notes: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–¥—ã"
            });
        }

        function submit(payload) {
            tg.MainButton.show();
            tg.MainButton.setText("–°–û–•–†–ê–ù–ï–ù–ò–ï...");
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            }).then(() => {
                setTimeout(() => location.reload(), 1200);
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fitness Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #38bdf8; --gray: #94a3b8; --green: #10b981; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; overflow-x: hidden; padding-bottom: 100px; }
        
        #registration-screen, #main-dashboard { display: none; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .full-width { grid-column: span 2; }
        
        h2 { margin: 0 0 10px; font-size: 12px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; }
        .value { font-size: 24px; font-weight: 800; }
        .unit { font-size: 12px; color: var(--gray); }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä—ã */
        .circle-container { position: relative; width: 80px; height: 80px; margin: 5px auto; }
        svg { transform: rotate(-90deg); width: 80px; height: 80px; }
        circle { fill: none; stroke-width: 6; stroke: #334155; }
        .progress { stroke: var(--accent); stroke-dasharray: 226; stroke-dashoffset: 226; transition: stroke-dashoffset 0.8s ease; stroke-linecap: round; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-main { background: var(--accent); color: #0f172a; border: none; width: 100%; padding: 15px; border-radius: 15px; font-weight: bold; cursor: pointer; }
        .btn-food { background: var(--green); color: white; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–®—Ç–æ—Ä–∫–∞) */
        .modal { position: fixed; bottom: -100%; left: 0; width: 100%; background: var(--card); border-radius: 25px 25px 0 0; padding: 25px; box-sizing: border-box; transition: 0.4s; z-index: 1000; box-shadow: 0 -10px 20px rgba(0,0,0,0.5); }
        .modal.active { bottom: 0; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 999; }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 1px solid #334155; background: #111827; color: white; font-size: 16px; box-sizing: border-box; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 10000; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div id="registration-screen">
        <div class="card">
            <h2>–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <input type="number" id="reg-height" placeholder="–†–æ—Å—Ç (—Å–º)">
            <input type="number" id="reg-age" placeholder="–í–æ–∑—Ä–∞—Å—Ç">
            <select id="reg-body">
                <option value="–°—Ä–µ–¥–Ω–µ–µ">–°—Ä–µ–¥–Ω–µ–µ —Ç–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ</option>
                <option value="–•—É–¥–æ—â–∞–≤–æ–µ">–•—É–¥–æ—â–∞–≤–æ–µ</option>
                <option value="–ü–ª–æ—Ç–Ω–æ–µ">–ü–ª–æ—Ç–Ω–æ–µ</option>
            </select>
            <button class="btn-main" onclick="saveProfile()">–°–û–ó–î–ê–¢–¨</button>
        </div>
    </div>

    <div id="main-dashboard">
        <div class="card full-width">
            <h2 id="user-name">–§–∏—Ç–Ω–µ—Å –¢—Ä–µ–∫–µ—Ä</h2>
            <div class="dashboard">
                <div>
                    <h2>–®–∞–≥–∏</h2>
                    <div class="value" id="steps-val">0</div>
                </div>
                <div>
                    <h2>–í–µ—Å</h2>
                    <div class="value" id="weight-val">--</div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>–í–æ–¥–∞</h2>
                <div class="circle-container">
                    <svg viewBox="0 0 80 80">
                        <circle cx="40" cy="40" r="36"/>
                        <circle class="progress" id="water-circle" cx="40" cy="40" r="36"/>
                    </svg>
                </div>
                <div class="unit" id="water-text">0/2000 –º–ª</div>
            </div>
            <div class="card">
                <h2>–ï–¥–∞</h2>
                <div style="font-size: 24px; margin-top: 15px;">üçé</div>
                <div class="unit" id="kcal-val">0 –∫–∫–∞–ª</div>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-main" onclick="openModal('entry')">–ê–ö–¢–ò–í–ù–û–°–¢–¨ +</button>
            <button class="btn-main btn-food" onclick="openModal('food')">–ï–î–ê +</button>
        </div>
    </div>

    <div id="overlay" class="modal-overlay" onclick="closeModals()"></div>
    <div id="modal-food" class="modal">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –µ–¥—É</h2>
        <select id="food-type">
            <option value="breakfast">–ó–∞–≤—Ç—Ä–∞–∫</option>
            <option value="lunch">–û–±–µ–¥</option>
            <option value="dinner">–£–∂–∏–Ω</option>
            <option value="snack">–ü–µ—Ä–µ–∫—É—Å</option>
        </select>
        <input type="number" id="food-kcal" placeholder="–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)" inputmode="numeric">
        <button class="btn-main btn-food" onclick="sendFood()">–°–û–•–†–ê–ù–ò–¢–¨ –ï–î–£</button>
    </div>

    <div id="modal-entry" class="modal">
        <h2>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
        <input type="number" id="in-weight" placeholder="–í–µ—Å (–∫–≥)" step="0.1">
        <input type="number" id="in-steps" placeholder="–®–∞–≥–∏">
        <input type="number" id="in-water" placeholder="–í–æ–¥–∞ (–º–ª)">
        <button class="btn-main" onclick="sendEntry()">–°–û–•–†–ê–ù–ò–¢–¨ –î–ê–ù–ù–´–ï</button>
    </div>

<script>
        const tg = window.Telegram.WebApp;
        // –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Å—å, —á—Ç–æ —ç—Ç–æ—Ç URL —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º –≤ Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbwOIq6saiwkDiOvCsGOZJDMqLOLEajYNo0Q4biXOVweoQmVuebFYFbGSgBWpTjZ2vk/exec'; 
        const user = tg.initDataUnsafe.user || { id: 12345, first_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' };
        let profile = {};

        tg.ready();
        tg.expand();

        // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        fetch(`${API_URL}?userId=${user.id}&userName=${user.first_name}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                if (data.needRegistration) {
                    document.getElementById('registration-screen').style.display = 'block';
                } else {
                    document.getElementById('main-dashboard').style.display = 'block';
                    profile = data.profile; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è (—Ä–æ—Å—Ç, –≤–æ–∑—Ä–∞—Å—Ç)
                    if (data.lastStats) updateUI(data.lastStats);
                }
            })
            .catch(err => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
                document.getElementById('loading').innerText = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
            });

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveProfile() {
            const height = document.getElementById('reg-height').value;
            const age = document.getElementById('reg-age').value;
            const bodyType = document.getElementById('reg-body').value;

            if (!height || !age) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏ —Ä–æ—Å—Ç –∏ –≤–æ–∑—Ä–∞—Å—Ç!");
                return;
            }

            const data = {
                userId: user.id,
                type: 'register',
                height: height,
                age: age,
                bodyType: bodyType
            };

            tg.MainButton.show();
            tg.MainButton.setText("–°–û–ó–î–ê–ù–ò–ï –ü–†–û–§–ò–õ–Ø...");
            submit(data);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        function updateUI(stats) {
            document.getElementById('steps-val').innerText = stats.steps || 0;
            document.getElementById('weight-val').innerText = stats.weight || '--';
            
            const waterFact = stats.water || 0;
            const waterGoal = stats.waterGoal || 2000;
            document.getElementById('water-text').innerText = `${waterFact}/${waterGoal} –º–ª`;
            
            // –†–∞—Å—á–µ—Ç –∫–æ–ª—å—Ü–∞ –≤–æ–¥—ã
            const offset = 226 - (226 * Math.min(waterFact / waterGoal, 1));
            document.getElementById('water-circle').style.strokeDashoffset = offset;

            // –°—É–º–º–∏—Ä—É–µ–º –∫–∞–ª–æ—Ä–∏–∏ –∑–∞ –≤—Å–µ –ø—Ä–∏–µ–º—ã –ø–∏—â–∏
            if (stats.meals) {
                const totalKcal = (Number(stats.meals.breakfast) || 0) + 
                                  (Number(stats.meals.lunch) || 0) + 
                                  (Number(stats.meals.dinner) || 0) + 
                                  (Number(stats.meals.snack) || 0);
                document.getElementById('kcal-val').innerText = `${totalKcal} –∫–∫–∞–ª`;
            }
        }

        function openModal(type) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('modal-' + type).classList.add('active');
        }

        function closeModals() {
            document.getElementById('overlay').style.display = 'none';
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        function sendFood() {
            const type = document.getElementById('food-type').value;
            const kcal = document.getElementById('food-kcal').value;
            if (!kcal) return;

            const data = {
                userId: user.id,
                type: 'food_entry',
                mealType: type,
                kcal: kcal,
                height: profile.height, 
                age: profile.age, 
                bodyType: profile.bodyType
            };
            submit(data);
        }

function sendEntry() {
    const data = {
        userId: user.id,
        type: 'activity', // —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ GAS
        weight: document.getElementById('in-weight').value,
        steps: document.getElementById('in-steps').value,
        water: document.getElementById('in-water').value,
        waterGoal: 2000,
        height: profile.height, 
        age: profile.age, 
        bodyType: profile.bodyType
    };
    submit(data);
}

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        function submit(payload) {
            tg.MainButton.show();
            tg.MainButton.setText("–°–û–•–†–ê–ù–ï–ù–ò–ï...");
            
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', // –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Apps Script
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            }).then(() => {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π, —á—Ç–æ–±—ã GAS —É—Å–ø–µ–ª –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å
                setTimeout(() => {
                    tg.MainButton.hide();
                    location.reload();
                }, 1200);
            }).catch(err => {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ");
                tg.MainButton.hide();
            });
        }
    </script>
</body>
</html>